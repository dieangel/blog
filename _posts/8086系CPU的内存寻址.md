---
title: 8086系CPU的内存寻址
toc: true
date: 2016-12-03 20:03:35
tags: [CPU, 8086, 内存管理, Linux]
categories: Device
---
大学时候，电子科学专业学过一门课程《微机技术原理与接口技术》，当时对里面的芯片介绍，汇编语言不甚明了，直至今日也不是很明白，恰好前几天看到Linux的内存分页机制的时候，回家把书捡起来看了一下，加深一下了解。
<!--more-->
# CPU的工作流程
大体上来说，CPU是计算机中的大脑，负责从**总线（BUS）**读取数据，然后执行，最后得出结果通过总线输出。而其中各个流程的处理，分由不同的单元进行处理。
## CPU的工作组成
- **总线接口部件BIU（Bus Interface Unit)**
	负责地址形成（把逻辑地址转换为物理地址）、取指令、指令队列、读/写操作数和总线控制。
	其主要结构包含：16位的段寄存器（CS、DS、ES、SS）、指令指针寄存器（IP）、20位物理地址加法器、6字节指令队列、总线控制电路。
- **指令执行部件EU（Execution Unix)**
    负责将取指令队列中的指令进行译码后执行。
	主要结构包含：16位的通用寄存器（AX、BX、CX、DX）、算数逻辑单元（ALU）、标志寄存器（flags，存放ALU的结果特征）、EU控制电路。
# 内存结构（Random Access Memory）
我们常用的内存，不论是 **静态存储器SRAM**，还是 **动态存储器DRAM**，其结构都是一样的，由__m*个*nbit__的存储单元组成存储矩阵。
比如，我们常用的内存最小单位是**Byte**，也就是8bit，一个单元。每次地址总线访问某个内存地址（物理地址）内的内容，都是一次性将这8bit数据读出来（其实是8个单元点路的电平情况，每个电路是0/1），那么就需要8条数据总线才能实现这个目的。
而地址总线则限制了，CPU能进行物理寻址的范围是多大，8086是20位地址总线（其能寻址地址最大自然是2^20）、16位数据总线。
如果我们的用8bit的存储单元来满足我们需要4GRAM的需求，那我们需要多少个存储单元组织在一起呢？
```
4G=4\*1024\*1024\*1024 bit=2^32 bit 
```
所以需要2^29个存储单元。但很明显，20位地址总线并不能有效的利用这些内存，因为寻址范围不够。
那么有没有什么手段或者技术能把它利用起来呢？很明显是有的，比如你在x86架构的CPU在LINUX上启用**PAE**的时候，就能寻址超过64GB的内存。不过这暂不在我们讨论的范围。
## 高速缓存存储器（Cache)
CPU的时钟的周期是很短的，现在动不动就是**GHz**的频率。比如一个1GHz的CPU，其**时钟周期（T状态）**，也就是1ns。
CPU的工作过程就是执行指令的过程，每个指令周期（指令过程所需要的时钟周期数）是不同的，一般包含n（>=1）个总线周期。
每个总线周期即是BIU完成一次访问存储器或者I/O所需要的时间，包含n（>=1）个T状态。
而**SRAM**则快很多，当前已经有2ns的器件，但是其价格是非常昂贵的。其作用就是在CPU和RAM之间做一个缓存，每次CPU读取RAM数据的时候，就COPY一份到高速缓存（内存地址和内容）。下一次执行指令的时候就会看一下是不是地址在CACHE内有，有的话就直接读出而不访问RAM了。
而DRAM的读取时间（从总线给出的有效地址，到数据读出）远达不到1ns（MOS一般在50ns-500ms），所以每个总线周期才会需要很多个T状态，这对CPU来说这一种很大的浪费。
# 寻址
EU单元的内部寄存器都是16位，BIU的寄存器也是16位，其根本原因就是说，8086CPU的内部总线是16位的。其一次最多能传输2^16bit的数据，无论是地址，还是数据。因此其采用了段式内存管理。
其最多能寻址的空间是2^16（64KB），所以每段就设置为这么大（这个是操作系统完成内存的分段？）。当程序载入的时候，就为其分配CS、DS、SS、ES，将每个段的段地址分别保存在CS、DS、SS、ES段寄存器内，这样加上一定的偏移量（Offset）就得到了逻辑地址：段选择符（Segment Selector)+偏移量（Offset）。
然后BIU里面的物理地址加法器就会转将逻辑地址转换为物理地址：BaseAddr*16+Offset
